# 实施计划

- [x] 1. 设置项目结构和核心接口
  - 创建文档预处理模块的目录结构
  - 定义核心接口和数据结构（包括预留的向量化接口）
  - 设置Go模块依赖（LangChain Go等）
  - _需求: 1.1, 3.1_

- [-] 2. 实现数据模型和数据库结构
- [x] 2.1 创建文档块数据模型
  - 实现DocumentChunk结构体和相关类型
  - 创建数据验证函数
  - _需求: 4.1, 4.2_

- [x]* 2.2 为文档块模型编写属性测试
  - **属性 8: 存储完整性**
  - **验证: 需求 4.2**

- [x] 2.3 添加模型到数据库自动迁移
  - 在database.go中的AutoMigrate添加DocumentChunkModel
  - 在database.go中的AutoMigrate添加DocumentProcessingStatusModel
  - 预留DocumentEmbeddingModel（注释形式，暂不添加）
  - _需求: 4.1, 4.4_

- [ ]* 2.4 为数据库操作编写属性测试
  - **属性 9: 级联删除一致性**
  - **验证: 需求 4.4**

- [-] 3. 实现MinerU集成模块
- [x] 3.1 创建MinerU处理器接口实现
  - 实现MinerUProcessor结构体
  - 用context7读取文档 http API调用
  - 处理不同文档格式的转换逻辑,判断文本txt md不需要处理
  - _需求: 1.1, 2.1, 2.2, 2.3_

- [ ]* 3.2 为PDF转换编写属性测试
  - **属性 1: PDF转换一致性**
  - **验证: 需求 1.1**

- [ ]* 3.3 为公式保留编写属性测试
  - **属性 2: 公式保留性**
  - **验证: 需求 1.2**

- [ ]* 3.4 为表格转换编写属性测试
  - **属性 3: 表格格式转换**
  - **验证: 需求 1.3**

- [x] 3.5 实现文档格式检测和转换
  - 添加文件格式检测逻辑
  - 实现Word到PDF的转换
  - 实现PowerPoint文本提取
  - _需求: 2.2, 2.3, 2.5_

- [ ]* 3.6 为图像处理编写属性测试
  - **属性 4: 图像引用完整性**
  - **验证: 需求 1.4**

- [ ]* 3.7 为结构保留编写属性测试
  - **属性 5: 结构信息保留**
  - **验证: 需求 1.5**

- [-] 4. 实现LangChain Go文本分块器
- [x] 4.1 创建TextChunker接口实现
  - 集成LangChain Go的RecursiveCharacter分割器
  - 实现自定义分块参数配置
  - 添加段落语义完整性保护
  - _需求: 3.1, 3.2, 3.3_

- [ ]* 4.2 为分块连续性编写属性测试
  - **属性 6: 分块连续性**
  - **验证: 需求 3.3, 7.2**

- [ ]* 4.3 为唯一标识符编写属性测试
  - **属性 7: 块唯一标识符**
  - **验证: 需求 3.5**

- [x] 4.4 实现分块元数据生成
  - 为每个块生成唯一ID和元数据
  - 计算块的偏移量和索引
  - _需求: 3.5_

- [-] 5. 实现文档块存储库
- [x] 5.1 创建DocumentChunkRepository实现
  - 实现CRUD操作方法
  - 添加批量插入和更新功能
  - 实现按文档ID查询功能
  - _需求: 4.1, 4.2, 4.5_

- [ ]* 5.2 为更新操作编写属性测试
  - **属性 10: 更新操作原子性**
  - **验证: 需求 4.3**

- [x] 5.3 实现级联删除逻辑
  - 添加文档删除时的块清理
  - 实现事务性删除操作
  - _需求: 4.4_

- [ ] 6. 实现文档预处理服务
- [x] 6.1 创建DocumentPreprocessingService实现
  - 实现主要的预处理流程协调
  - 集成MinerU处理器和文本分块器
  - 添加处理状态管理
  - _需求: 1.1, 3.1, 4.1_

- [ ]* 6.2 为错误处理编写属性测试
  - **属性 11: 错误处理完整性**
  - **验证: 需求 5.1**

- [x] 6.3 实现异步处理队列
  - 添加任务队列管理
  - 实现并发处理逻辑
  - 添加处理进度跟踪
  - _需求: 6.1, 6.2_

- [ ]* 6.4 为异步队列编写属性测试
  - **属性 12: 异步队列可靠性**
  - **验证: 需求 6.1**

- [x] 6.5 实现错误处理和重试机制
  - 添加处理失败的重试逻辑
  - 实现优雅的错误恢复
  - 添加详细的错误日志记录
  - _需求: 5.1, 5.2, 5.3_

- [ ] 7. 实现质量验证模块
- [x] 7.1 创建转换质量验证器
  - 实现Markdown格式验证
  - 添加内容完整性检查
  - 实现转换质量评分
  - _需求: 7.1, 7.3_

- [ ]* 7.2 为质量验证编写属性测试
  - **属性 13: 质量验证完整性**
  - **验证: 需求 7.1, 7.4**

- [x] 7.3 实现分块质量验证
  - 验证块之间的连续性
  - 检查重叠设置的正确性
  - 验证数据完整性
  - _需求: 7.2, 7.4_

- [x] 7.4 添加特殊字符处理
  - 实现编码检测和转换
  - 添加特殊字符转义处理
  - _需求: 7.5_

- [ ] 8. 实现HTTP API处理器
- [x] 8.1 创建DocumentPreprocessingHandler
  - 实现文档预处理API端点
  - 添加处理状态查询端点
  - 实现批量处理端点
  - 添加向量化处理端点（预留接口）
  - _需求: 8.4, 9.1_

- [ ]* 8.2 为状态查询编写属性测试
  - **属性 15: 状态查询一致性**
  - **验证: 需求 10.1, 10.2**

- [x] 8.3 添加API输入验证和错误处理
  - 实现请求参数验证
  - 添加统一的错误响应格式
  - 实现API限流机制
  - _需求: 5.5, 6.4_

- [x] 8.4 集成到现有路由系统
  - 将新的API端点添加到路由器
  - 配置中间件和认证
  - _需求: 8.4_

- [ ] 9. 实现系统集成
- [x] 9.1 集成向量化处理触发（预留接口）
  - 实现预处理完成后的事件触发机制
  - 定义向量化处理器的调用接口（暂时使用空实现）
  - 为未来向量化模块集成预留扩展点
  - _需求: 8.1_

- [ ]* 9.2 为集成触发编写属性测试
  - **属性 14: 集成触发一致性**
  - **验证: 需求 8.1**

- [x] 9.3 集成S3对象存储
  - 支持从S3存储读取原始文档
  - 将处理结果存储到S3
  - _需求: 8.3_

- [x] 9.4 实现统一的元数据格式
  - 确保与现有文档服务的兼容性
  - 实现标准化的文档ID格式
  - _需求: 8.2_

- [ ] 10. 添加监控和健康检查
- [x] 10.1 实现处理指标收集
  - 添加处理时间、成功率等指标
  - 实现队列长度和处理吞吐量监控
  - _需求: 8.5_

- [x] 10.2 创建健康检查端点
  - 实现系统健康状态检查
  - 添加依赖服务的健康检查
  - _需求: 8.5_

- [x] 10.3 集成日志记录系统
  - 添加结构化日志记录
  - 实现处理过程的详细日志
  - _需求: 5.1_

- [x] 11. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 12. 性能优化和配置
- [x] 12.1 实现内存管理优化
  - 添加大文档的流式处理
  - 实现内存使用监控和限制
  - _需求: 5.2, 6.3_

- [x] 12.2 优化并发处理性能
  - 调整并发处理参数
  - 实现智能负载均衡
  - _需求: 6.2, 6.4_

- [x] 12.3 添加配置管理
  - 实现可配置的处理参数
  - 添加环境特定的配置
  - _需求: 3.2_

- [ ] 13. 实现前端集成组件
- [x] 13.1 创建文档处理状态API服务
  - 实现前端调用的API服务类
  - 添加状态轮询机制
  - 实现错误处理和重试逻辑
  - _需求: 9.2, 10.1, 10.2_

- [x] 13.2 实现文档操作按钮组件
  - 创建预处理和向量化按钮组件
  - 添加按钮状态管理和进度显示
  - 实现操作确认和错误提示
  - _需求: 9.1, 9.2, 9.4_

- [ ]* 13.3 为按钮状态同步编写属性测试
  - **属性 16: 按钮状态同步**
  - **验证: 需求 9.2, 9.4**

- [x] 13.4 集成到文档列表页面
  - 将操作按钮添加到现有文档列表
  - 实现状态显示和实时更新
  - 添加批量操作支持
  - _需求: 9.1, 10.5_

- [x] 13.5 实现处理状态详情页面
  - 创建详细的处理状态查看页面
  - 显示处理历史和错误详情
  - 添加重试和取消操作
  - _需求: 10.3, 10.4_

- [ ] 14. 前端样式和用户体验优化
- [x] 14.1 实现响应式设计
  - 适配不同屏幕尺寸的按钮布局
  - 优化移动端的操作体验
  - _需求: 9.1_

- [x] 14.2 添加加载动画和进度指示器
  - 实现处理过程的视觉反馈
  - 添加进度条和状态图标
  - _需求: 9.4, 10.1_


- [x] 15. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户