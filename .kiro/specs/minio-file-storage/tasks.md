# 实施计划

- [x] 1. 设置MinIO Docker环境
  - 更新docker-compose.yml添加MinIO服务
  - 配置MinIO访问凭据和存储桶
  - 验证MinIO服务可以正常启动
  - _需求: 1.1, 1.2_

- [x] 2. 添加环境变量配置
  - 在.env.example中添加S3兼容存储配置
  - 配置MinIO访问凭据和端点
  - _需求: 4.1, 4.3, 4.4_

- [x] 3. 添加S3配置支持到Config结构
  - 在config.go中添加S3Config配置结构
  - 添加环境变量映射和默认值
  - 实现配置验证逻辑
  - _需求: 4.1, 4.3, 4.4_

- [ ]* 3.1 为S3配置编写属性测试
  - **属性 4: API兼容性**
  - **验证: 需求 2.1**

- [x] 4. 集成MinIO Go客户端
  - 添加minio-go依赖到go.mod
  - 创建MinIO客户端初始化代码
  - 实现基本连接测试和存储桶创建
  - _需求: 1.3, 1.4_

- [ ]* 4.1 为MinIO客户端编写单元测试
  - 测试客户端初始化
  - 测试连接验证
  - 测试错误处理
  - _需求: 1.3, 1.4_

- [x] 5. 更新数据库模型
  - 为UploadSession添加MinIO UploadID字段
  - 创建数据库迁移脚本
  - 更新Document模型FilePath字段用于存储S3对象键
  - _需求: 6.2_

- [x] 6. 修改DocumentService使用MinIO存储
  - 更新Upload方法使用MinIO PutObject
  - 实现GetObject方法用于文件下载
  - 更新Delete方法使用MinIO RemoveObject
  - 保持现有方法签名不变
  - _需求: 2.1, 2.3, 3.1_

- [ ]* 6.1 为文件上传下载编写属性测试
  - **属性 1: 文件上传往返一致性**
  - **验证: 需求 2.3, 3.1**

- [x] 7. 实现MinIO分块上传
  - 修改InitUpload使用MinIO NewMultipartUpload
  - 修改UploadChunk使用MinIO PutObjectPart
  - 修改CompleteUpload使用MinIO CompleteMultipartUpload
  - 处理上传中止和清理
  - _需求: 7.1, 7.2, 7.3, 7.4_

- [ ]* 7.1 为分块上传编写属性测试
  - **属性 2: 分块上传完整性**
  - **验证: 需求 7.1, 7.2, 7.3**

- [x] 8. 实现文件去重功能
  - 修改去重逻辑检查MinIO对象
  - 使用对象哈希作为去重键
  - 实现引用计数删除
  - _需求: 2.5, 8.1, 8.2, 8.3_

- [ ]* 8.1 为文件去重编写属性测试
  - **属性 3: 文件去重正确性**
  - **验证: 需求 2.5, 8.1, 8.2, 8.5**

- [x] 9. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [x] 10. 添加错误处理和重试机制
  - 实现网络错误重试
  - 添加详细错误日志
  - 处理MinIO服务不可用情况
  - _需求: 5.1, 5.2_

- [ ]* 10.1 为错误处理编写单元测试
  - 测试重试机制
  - 测试错误日志记录
  - 测试故障恢复
  - _需求: 5.1, 5.2_


- [x] 12. 前端兼容性验证
  - 验证现有前端代码无需修改
  - 测试文件上传功能
  - 测试进度显示
  - 测试错误处理
  - _需求: 2.1, 2.4_

- [ ]* 12.1 为前端功能编写测试
  - **属性 5: 前端功能一致性**
  - **验证: 需求 2.1, 2.4**

- [x] 13. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户